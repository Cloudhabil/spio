# Sovereign PIO - Multi-Service Orchestration

version: '3.8'

services:
  # ==========================================================================
  # SUBSTRATE GATEWAY - FastAPI server wired to SovereignRuntime
  # ==========================================================================
  gateway:
    build:
      context: ..
      dockerfile: infrastructure/Dockerfile
    ports:
      - "8009:8009"
    volumes:
      - spio-data:/app/data
      - spio-npu:/app/data/npu
    environment:
      - PYTHONPATH=/app/src
      - SPIO_LLM_PROVIDER=${SPIO_LLM_PROVIDER:-echo}
      - SPIO_LLM_MODEL=${SPIO_LLM_MODEL:-llama3.2}
      - SPIO_LLM_HOST=http://host.docker.internal:11434
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8009/api/status')"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    restart: unless-stopped
    networks:
      - spio-network

  # ==========================================================================
  # MCP SERVER - Model Context Protocol
  # ==========================================================================
  mcp:
    build:
      context: ..
      dockerfile: infrastructure/Dockerfile
    command: ["python", "-m", "integrations.mcp_server"]
    volumes:
      - spio-data:/app/data
    environment:
      - PYTHONPATH=/app/src
    stdin_open: true
    tty: true
    networks:
      - spio-network

  # ==========================================================================
  # WAVELENGTH WORKER - Background wavelength processing loop
  # ==========================================================================
  worker:
    build:
      context: ..
      dockerfile: infrastructure/Dockerfile
    command: >
      python -c "
      import sys, time, logging;
      sys.path.insert(0, 'src');
      logging.basicConfig(level=logging.INFO);
      from core.wavelengths import WavelengthGate;
      gate = WavelengthGate(threshold=0.1, enable_learning=True, enable_convergence=True, auto_persist=True);
      print('Worker ready â€” wavelength gate active');
      while True:
          stats = gate.get_stats();
          print(f'Wavelength worker: updates={stats[\"updates\"]}, events={stats[\"events\"]}');
          time.sleep(60)
      "
    volumes:
      - spio-data:/app/data
      - spio-npu:/app/data/npu
    environment:
      - PYTHONPATH=/app/src
    depends_on:
      gateway:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - spio-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  spio-data:
    driver: local
  spio-npu:
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  spio-network:
    driver: bridge
